<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>TENKU Demo Player</title>
  <style>
    :root { --track-gap: 40px; --fg: #fff; --fg-dim:#ddd; --fg-muted:#aaa; }
    .bg{position:fixed;inset:0;z-index:-1;overflow:hidden}
    .bg__layer{position:absolute;inset:0;background-size:cover;background-position:center;background-repeat:no-repeat;opacity:0;transition:opacity .4s ease}
    .bg__layer.is-active{opacity:1}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;color:var(--fg);min-height:100vh;display:flex;flex-direction:column}
    h1{font-size:1.2rem;text-align:center;margin:20px 0 10px;font-weight:600;text-shadow:0 2px 4px rgba(0,0,0,.6)}
    select,input[type=range]{width:90%;margin:8px auto;display:block;font-size:1rem;color:var(--fg);background:transparent;border:none}
    select{border-bottom:1px solid #ccc;padding:8px 0} select:focus{outline:none;border-bottom-color:#fff}
    .controls{display:flex;justify-content:center;align-items:center;gap:var(--track-gap);margin:18px 0 14px}
    .controls button{background:none;border:none;color:var(--fg);font-size:2rem;padding:8px 10px;text-shadow:0 2px 4px rgba(0,0,0,.6)}
    .controls button:active{opacity:.6}
    input[type=range]{-webkit-appearance:none;background:transparent}
    input[type=range]::-webkit-slider-runnable-track{height:2px;background:#eee}
    input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;height:14px;width:14px;border-radius:50%;background:#fff;margin-top:-6px}
    input[type=range]::-moz-range-track{height:2px;background:#eee}
    input[type=range]::-moz-range-thumb{height:14px;width:14px;border-radius:50%;background:#fff;border:0}
    .time{width:90%;margin:4px auto 8px;display:flex;justify-content:space-between;font-size:.8rem;color:var(--fg-muted);text-shadow:0 1px 3px rgba(0,0,0,.6)}
    .msg{width:90%;margin:6px auto 0;color:#ffdede;font-size:.8rem}
    .footer{font-size:.7rem;text-align:center;color:var(--fg-dim);padding:12px 10px 16px;margin-top:auto;text-shadow:0 1px 3px rgba(0,0,0,.6)}
    @media(min-width:480px){:root{--track-gap:56px}h1{margin-top:28px}}
  </style>
</head>
<body>
  <div class="bg" aria-hidden="true">
    <div id="bgA" class="bg__layer is-active"></div>
    <div id="bgB" class="bg__layer"></div>
  </div>

  <h1>TENKU Demo Player</h1>

  <select id="track" aria-label="トラックを選択">
    <option value="1">M3TOKYO</option>
    <option value="2">雷雨</option>
    <option value="3">ホワイトノイズ</option>
  </select>

  <div class="controls" role="group" aria-label="再生コントロール">
    <button id="prevBtn" aria-label="前の曲へ">⏮️</button>
    <button id="playBtn" aria-label="再生">▶️</button>
    <button id="nextBtn" aria-label="次の曲へ">⏭️</button>
  </div>

  <input type="range" id="seek" min="0" value="0" aria-label="再生位置">
  <div class="time">
    <span id="current">00:00</span>
    <span id="duration">00:00</span>
  </div>

  <input type="range" id="volume" min="0" max="1" step="0.01" value="1" aria-label="音量">
  <div id="msg" class="msg"></div>

  <div class="footer">© 2025 KOBE TENKU RESORT</div>

  <audio id="audio" preload="auto" playsinline></audio>

  <script>
    const bgMap={1:"./assets/images/bg1.jpg",2:"./assets/images/bg2.jpg",3:"./assets/images/bg3.jpg"};
    const audio=document.getElementById('audio');
    const playBtn=document.getElementById('playBtn');
    const prevBtn=document.getElementById('prevBtn');
    const nextBtn=document.getElementById('nextBtn');
    const trackSel=document.getElementById('track');
    const seek=document.getElementById('seek');
    const current=document.getElementById('current');
    const duration=document.getElementById('duration');
    const volume=document.getElementById('volume');
    const bgA=document.getElementById('bgA');
    const bgB=document.getElementById('bgB');
    const msg=document.getElementById('msg');
    let activeIsA=true;

    const fmt=t=>`${String(Math.floor(t/60)).padStart(2,'0')}:${String(Math.floor(t%60)).padStart(2,'0')}`;

    function setBackground(num){
      const url=bgMap[num];
      const front=activeIsA?bgB:bgA, back=activeIsA?bgA:bgB;
      const img=new Image();
      img.onload=()=>{front.style.backgroundImage=`url("${url}")`;front.classList.add('is-active');back.classList.remove('is-active');activeIsA=!activeIsA;};
      img.onerror=()=>{msg.textContent=`背景が読み込めません: ${url}`;}
      img.src=url;
    }

    function loadTrack(num, autoPlay=false){
      const src=`./assets/audio/sound${num}.mp3`;
      audio.innerHTML=`<source src="${src}" type="audio/mpeg">`;
      audio.load();
      playBtn.textContent="▶️";
      setBackground(num);
      msg.textContent="";
      if(autoPlay){
        audio.play().then(()=>{playBtn.textContent="⏸️";}).catch((e)=>{msg.textContent="再生できませんでした。端末のサイレント/音量をご確認のうえ、もう一度押してください。"; console.warn(e);});
      }
    }

    playBtn.addEventListener('click',async()=>{
      try{
        if(audio.paused){ await audio.play(); playBtn.textContent="⏸️"; msg.textContent=""; }
        else { audio.pause(); playBtn.textContent="▶️"; }
      }catch(e){ msg.textContent="再生がブロックされました。画面をタップしてからもう一度試してください。"; console.warn(e); }
    });

    prevBtn.addEventListener('click',()=>{let i=Number(trackSel.value); i=(i-2+3)%3+1; trackSel.value=i; loadTrack(i,true);});
    nextBtn.addEventListener('click',()=>{let i=Number(trackSel.value); i=(i%3)+1; trackSel.value=i; loadTrack(i,true);});
    trackSel.addEventListener('change',e=>loadTrack(Number(e.target.value),true));

    audio.addEventListener('loadedmetadata',()=>{duration.textContent=fmt(audio.duration||0); seek.max=audio.duration||0;});
    audio.addEventListener('timeupdate',()=>{seek.value=audio.currentTime||0; current.textContent=fmt(audio.currentTime||0);});
    seek.addEventListener('input',e=>{audio.currentTime=Number(e.target.value)||0;});
    volume.addEventListener('input',e=>{audio.volume=Number(e.target.value);});

    audio.addEventListener('error',()=>{const s=audio.querySelector('source')?.src||""; msg.textContent=`サウンドが読み込めません: ${s}`;});
    audio.addEventListener('ended',()=>{let i=Number(trackSel.value); i=(i%3)+1; trackSel.value=i; loadTrack(i,true);});

    (function init(){ const first=Number(trackSel.value); bgA.style.backgroundImage=`url("${bgMap[first]}")`; bgA.classList.add('is-active'); bgB.style.backgroundImage=`url("${bgMap[first]}")`; loadTrack(first,false); })();
  </script>
</body>
</html>
