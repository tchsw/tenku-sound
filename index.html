<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>TENKU Sound Player</title>
<style>
  :root{
    --accent:#f0c27b;            /* リング色（お好みで） */
    --accent-weak:#ffffff40;     /* 薄いリング */
    --text:#fff;
  }

  *{ box-sizing:border-box; }
  body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,"SF Pro Display","Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    color:var(--text);
    background:#000;
    min-height:100vh;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:flex-start;
    text-align:center;
    padding:18px 14px 110px; /* 下部プレイヤー余白 */
  }

  /* 背景クロスフェード */
  .bg__layer{
    position:fixed; inset:0;
    background-size:cover; background-position:center;
    opacity:0; transition:opacity .6s ease;
    z-index:-1;
  }
  .bg__layer.is-active{ opacity:1; }

  /* ヘッダー */
  .topbar{
    width:100%; max-width:520px;
    display:flex; align-items:center; justify-content:center;
    gap:8px; margin-top:4px; margin-bottom:8px;
    opacity:.95;
  }
  .title{
    font-size:1.1rem; font-weight:300;
    letter-spacing:.04em;
  }

  /* 曲名エリア */
  .meta{
    margin-top:2px;
  }
  .track-title{
    font-size:1.2rem; font-weight:600; margin:0;
  }
  .track-sub{
    font-size:.82rem; opacity:.8; margin-top:4px;
  }

  /* 円形カバー & 進捗リング */
  .cover-wrap{
    position:relative;
    width:min(78vw,360px);
    aspect-ratio:1/1;
    margin:18px auto 14px;
  }

  /* 外周リング（conic-gradient） */
  .ring{
    position:absolute; inset:0;
    border-radius:999px;
    background:
      conic-gradient(var(--accent) calc(var(--progress,0)*1turn),
                     var(--accent-weak) 0);
    filter: drop-shadow(0 2px 6px rgba(0,0,0,.35));
    padding:10px;              /* リング太さ */
  }

  /* カバー画像（円形） */
  .cover{
    width:100%; height:100%;
    border-radius:999px;
    background-size:cover; background-position:center;
    overflow:hidden;
    position:relative;
  }

  /* 小さなノブ */
  .knob{
    position:absolute; inset:0; pointer-events:none;
  }
  .knob::after{
    content:"";
    position:absolute; left:50%; top:0;
    width:12px; height:12px; border-radius:999px;
    background:var(--accent);
    transform:translate(-50%,-6px) rotate(0turn);
    box-shadow:0 0 10px rgba(240,194,123,.8);
  }

  /* 中央プレイボタン（重ね） */
  .play-fab{
    position:absolute; inset:0;
    display:flex; align-items:center; justify-content:center;
  }
  .fab{
    width:72px; height:72px; border-radius:999px;
    background:#ffffffee; color:#111;
    display:grid; place-items:center;
    box-shadow:0 10px 30px rgba(0,0,0,.35);
    border:none;
  }
  .fab svg{ width:36px; height:36px; fill:currentColor; }

  /* コントロール（前/次＋時間） */
  .time-row{
    width:100%; max-width:520px;
    display:flex; align-items:center; justify-content:space-between;
    font-size:.8rem; opacity:.9; margin:4px auto 8px;
  }

  .controls{
    width:100%; max-width:520px;
    display:flex; align-items:center; justify-content:center;
    gap:36px; margin:8px auto 10px;
  }
  .icon-btn{
    background:none; border:none; color:#fff;
    padding:10px; display:grid; place-items:center;
  }
  .icon-btn svg{ width:28px; height:28px; fill:currentColor; }
  .icon-btn:active{ opacity:.6; }

  /* シークバー（反転） */
  .seek{
    width:100%; max-width:520px; margin:4px auto 0;
    -webkit-appearance:none; background:transparent; mix-blend-mode:difference;
  }
  .seek::-webkit-slider-runnable-track{ height:2px; background:#fff; }
  .seek::-webkit-slider-thumb{ -webkit-appearance:none; width:14px; height:14px; background:#fff; border-radius:50%; margin-top:-6px; }
  .seek::-moz-range-track{ height:2px; background:#fff; }
  .seek::-moz-range-thumb{ width:14px; height:14px; background:#fff; border:none; border-radius:50%; }

  /* 音量（左アイコン＋反転スライダー） */
  .volume{
    width:100%; max-width:520px;
    display:flex; align-items:center; gap:10px; margin:16px auto 0;
  }
  .volume svg{ width:20px; height:20px; flex-shrink:0; }
  .vol-range{
    flex:1; -webkit-appearance:none; background:transparent; mix-blend-mode:difference;
  }
  .vol-range::-webkit-slider-runnable-track{ height:2px; background:#fff; }
  .vol-range::-webkit-slider-thumb{ -webkit-appearance:none; width:14px; height:14px; background:#fff; border-radius:50%; margin-top:-6px; }
  .vol-range::-moz-range-track{ height:2px; background:#fff; }
  .vol-range::-moz-range-thumb{ width:14px; height:14px; background:#fff; border:none; border-radius:50%; }

  /* フッター */
  .foot{ position:fixed; bottom:10px; left:0; width:100%; text-align:center; font-size:.7rem; opacity:.75; }
</style>
</head>
<body>
  <!-- 背景 -->
  <div id="bgA" class="bg__layer is-active"></div>
  <div id="bgB" class="bg__layer"></div>

  <!-- トップ -->
  <div class="topbar">
    <div class="title">TENKU Sound Player</div>
  </div>

  <!-- メタ -->
  <div class="meta">
    <h2 id="trackTitle" class="track-title">サンプルサウンド1</h2>
    <div class="track-sub" id="trackSub">Ambient · Loop</div>
  </div>

  <!-- 円形プレイヤー -->
  <div class="cover-wrap" aria-label="artwork">
    <div class="ring" id="ring" style="--progress:0;">
      <div class="cover" id="cover"></div>
      <div class="knob" id="knob"></div>
    </div>

    <div class="play-fab">
      <button id="fabPlay" class="fab" aria-label="再生/一時停止">
        <!-- play -->
        <svg id="fabPlayIcon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
      </button>
    </div>
  </div>

  <!-- 時間行 -->
  <div class="time-row">
    <span id="current">00:00</span>
    <span id="duration">00:00</span>
  </div>

  <!-- シーク -->
  <input type="range" id="seek" class="seek" min="0" value="0" aria-label="再生位置">

  <!-- 前/次 -->
  <div class="controls">
    <button id="prevBtn" class="icon-btn" aria-label="前の曲へ">
      <svg viewBox="0 0 24 24"><path d="M19 20V4L9 12l10 8zM5 20V4h2v16H5z"/></svg>
    </button>
    <button id="nextBtn" class="icon-btn" aria-label="次の曲へ">
      <svg viewBox="0 0 24 24"><path d="M5 4v16l10-8L5 4zm12 0v16h2V4h-2z"/></svg>
    </button>
  </div>

  <!-- 音量 -->
  <div class="volume">
    <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.06c1.48-.74 2.5-2.26 2.5-4.03z"/></svg>
    <input type="range" id="volume" class="vol-range" min="0" max="1" step="0.01" value="1" aria-label="音量">
  </div>

  <!-- 非表示だけど内部状態用 -->
  <select id="track" style="display:none">
    <option value="1">サンプルサウンド1</option>
    <option value="2">サンプルサウンド2</option>
    <option value="3">サンプルミュージック</option>
  </select>

  <div class="foot">© 2025 KOBE TENKU RESORT</div>

  <audio id="audio" preload="auto" playsinline></audio>

<script>
  const bust = `?v=${Date.now()}`;

  const bgMap = {
    1:`/assets/images/bg1.jpg${bust}`,
    2:`/assets/images/bg2.jpg${bust}`,
    3:`/assets/images/bg3.jpg${bust}`,
  };
  const trackNames = {
    1:"サンプルサウンド1",
    2:"サンプルサウンド2",
    3:"サンプルミュージック",
  };

  const audio   = document.getElementById('audio');
  const fabPlay = document.getElementById('fabPlay');
  const fabPlayIcon = document.getElementById('fabPlayIcon');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const trackSel= document.getElementById('track');
  const trackTitle = document.getElementById('trackTitle');
  const trackSub   = document.getElementById('trackSub');
  const seek   = document.getElementById('seek');
  const current= document.getElementById('current');
  const duration= document.getElementById('duration');
  const volume = document.getElementById('volume');
  const bgA    = document.getElementById('bgA');
  const bgB    = document.getElementById('bgB');
  const ring   = document.getElementById('ring');
  const knob   = document.getElementById('knob');
  const cover  = document.getElementById('cover');
  let activeIsA = true;

  /* ---- Web Audio (iOS音量対策) ---- */
  let audioCtx=null, gainNode=null, mediaSrc=null;
  function ensureAudioGraph(){
    if(audioCtx) return;
    const Ctx = window.AudioContext || window.webkitAudioContext;
    if(!Ctx) return; // フォールバック
    audioCtx = new Ctx();
    try{ mediaSrc = audioCtx.createMediaElementSource(audio); }catch(e){}
    gainNode = audioCtx.createGain();
    mediaSrc && mediaSrc.connect(gainNode);
    gainNode.connect(audioCtx.destination);
    gainNode.gain.value = Number(volume.value);
  }
  function resumeContextIfNeeded(){
    if(audioCtx && audioCtx.state==="suspended"){ audioCtx.resume().catch(()=>{}); }
  }
  function setVolumeFromSlider(v){
    const vol = Math.max(0,Math.min(1,Number(v)));
    if(gainNode){ gainNode.gain.value = vol; } else { audio.volume = vol; }
  }
  /* ---------------------------------- */

  const fmt=t=>`${String(Math.floor(t/60)).padStart(2,'0')}:${String(Math.floor(t%60)).padStart(2,'0')}`;

  function setBackground(num){
    const url = bgMap[num];
    const front = activeIsA ? bgB : bgA;
    const back  = activeIsA ? bgA : bgB;
    const img = new Image();
    img.onload=()=>{
      front.style.backgroundImage=`url("${url}")`;
      front.classList.add('is-active'); back.classList.remove('is-active');
      activeIsA = !activeIsA;
      // カバー画像も更新
      cover.style.backgroundImage=`url("${url}")`;
    };
    img.onerror=()=>{ console.warn("背景が読み込めません:",url); };
    img.src=url;
  }

  function loadTrack(num, autoPlay=false){
    const src = `/assets/audio/sound${num}.mp3${bust}`;
    audio.innerHTML = `<source src="${src}" type="audio/mpeg">`;
    audio.load();
    setBackground(num);
    trackTitle.textContent = trackNames[num];
    trackSub.textContent = "Ambient · Loop";

    if(autoPlay){
      ensureAudioGraph(); resumeContextIfNeeded();
      audio.play().then(()=> setPlaying(true)).catch(()=>{});
    }else{
      setPlaying(false);
    }
  }

  function setPlaying(playing){
    // 中央ボタンのアイコン切替
    fabPlayIcon.setAttribute("viewBox","0 0 24 24");
    fabPlayIcon.innerHTML = playing
      ? '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>'
      : '<path d="M8 5v14l11-7z"/>';
  }

  function setProgressUI(){
    const d = audio.duration || 0;
    const t = audio.currentTime || 0;
    seek.max = d; seek.value = t;
    current.textContent = fmt(t);
    duration.textContent = fmt(d);
    const p = d ? (t/d) : 0;
    ring.style.setProperty('--progress', p);
    knob.style.transform = `rotate(${p}turn)`;
  }

  /* 互換コントロール */
  fabPlay.addEventListener('click', async ()=>{
    ensureAudioGraph(); resumeContextIfNeeded();
    if(audio.paused){ try{ await audio.play(); setPlaying(true);}catch(e){} }
    else{ audio.pause(); setPlaying(false); }
  });
  prevBtn.addEventListener('click', ()=>{
    let i=Number(trackSel.value); i=(i-2+3)%3+1; trackSel.value=i; loadTrack(i,true);
  });
  nextBtn.addEventListener('click', ()=>{
    let i=Number(trackSel.value); i=(i%3)+1; trackSel.value=i; loadTrack(i,true);
  });

  seek.addEventListener('input', e=>{ audio.currentTime = Number(e.target.value)||0; setProgressUI(); });

  volume.addEventListener('input', e=>{ ensureAudioGraph(); resumeContextIfNeeded(); setVolumeFromSlider(e.target.value); });

  audio.addEventListener('loadedmetadata', setProgressUI);
  audio.addEventListener('timeupdate', setProgressUI);
  audio.addEventListener('ended', ()=>{
    let i=Number(trackSel.value); i=(i%3)+1; trackSel.value=i; loadTrack(i,true);
  });

  (function init(){
    const first = Number(trackSel.value);
    bgA.style.backgroundImage=`url("${bgMap[first]}")`;
    bgA.classList.add('is-active');
    cover.style.backgroundImage=`url("${bgMap[first]}")`;
    loadTrack(first,false);
    setVolumeFromSlider(volume.value);
  })();
</script>
</body>
</html>
