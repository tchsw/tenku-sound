<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>TENKU Sound Player</title>
<style>
  :root{
    --accent:#6F0001;
    --rest:#ffffff30;
    --text:#fff;
    --ring-thick:1px;
  }
  *{ box-sizing:border-box }
  body{
    margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    color:var(--text); background:#000; -webkit-text-size-adjust:100%; user-select:none;
  }
  .main{ min-height:100dvh; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:20px 12px 96px; }
  .bg__layer{position:fixed; inset:0; background-size:cover; background-position:center; opacity:0; transition:opacity .6s ease; z-index:-2;}
  .bg__layer.is-active{opacity:1;}
  .glass-bg{position:fixed; inset:0; backdrop-filter:blur(14px) saturate(120%); -webkit-backdrop-filter:blur(14px) saturate(120%); background:rgba(0,0,0,.28); z-index:-1;}
  .title{margin:6px 0 10px; font-size:1.1rem; font-weight:300; text-align:center;}
  .track-title{font-size:1.2rem; font-weight:600; margin:8px 0 0; text-align:center;}
  .track-sub{font-size:.82rem; opacity:.85; text-align:center;}
  .cover-wrap{position:relative; width:min(78vw,340px); aspect-ratio:1/1; margin:28px auto 16px; touch-action:none;}
  .cover{position:absolute; inset:calc(var(--ring-thick) * 3); border-radius:50%; background-size:cover; background-position:center;
         box-shadow:0 8px 28px rgba(0,0,0,.35), inset 0 0 0 1px #ffffff30;}
  .ring-rotor{position:absolute; inset:0; transform:rotate(-90deg);}
  .ring{position:absolute; inset:0; border-radius:50%; padding:var(--ring-thick);
        background:conic-gradient(var(--accent) 0deg calc(var(--progress,0) * 360deg), var(--rest) calc(var(--progress,0) * 360deg) 360deg);}
  .knob{position:absolute; inset:0; pointer-events:none;}
  .knob::after{content:""; position:absolute; left:50%; top:0; width:10px; height:10px; border-radius:50%; background:var(--accent);
               transform:translate(-50%,-6px) rotate(0deg); box-shadow:0 0 8px rgba(111,0,1,.8);}
  .time-row{position:absolute; top:-24px; left:50%; transform:translateX(-50%); display:flex; align-items:center; gap:6px;
            font-size:.82rem; opacity:.95; text-shadow:0 1px 2px rgba(0,0,0,.5);}
  .time-divider{opacity:.7;}
  .controls{display:flex; align-items:center; justify-content:center; gap:24px; margin-top:12px;}
  .icon-btn{background:none; border:none; color:#fff; padding:10px; display:grid; place-items:center;}
  .icon-btn svg{width:28px; height:28px; fill:currentColor;}
  #playBtn svg{width:36px; height:36px;}
  .icon-btn:active{opacity:.6;}
  .volume{width:100%; max-width:520px; display:flex; align-items:center; gap:10px; margin:20px auto 0;}
  .volume svg{width:20px; height:20px; fill:#fff;}
  .vol-range{flex:1; -webkit-appearance:none; background:transparent; mix-blend-mode:difference;}
  .vol-range::-webkit-slider-runnable-track{height:2px; background:#fff;}
  .vol-range::-webkit-slider-thumb{-webkit-appearance:none; width:14px; height:14px; border-radius:50%; background:#fff; margin-top:-6px;}
  .vol-range::-moz-range-track{height:2px; background:#fff;}
  .vol-range::-moz-range-thumb{width:14px; height:14px; border:none; border-radius:50%; background:#fff;}
  .foot{position:fixed; bottom:8px; left:0; width:100%; text-align:center; font-size:.7rem; opacity:.85;}
</style>
</head>
<body>
  <!-- 背景 -->
  <div id="bgA" class="bg__layer is-active"></div>
  <div id="bgB" class="bg__layer"></div>
  <div class="glass-bg" aria-hidden="true"></div>

  <main class="main">
    <div class="title">TENKU Sound Player</div>
    <div class="track-title" id="trackTitle">Track 2</div>
    <div class="track-sub" id="trackSub">Ambient · Loop</div>

    <div class="cover-wrap" id="dial">
      <div class="cover" id="cover"></div>
      <div class="ring-rotor">
        <div class="ring" id="ring" style="--progress:0;"></div>
        <div class="knob" id="knob"></div>
      </div>
      <div class="time-row">
        <span id="current">00:00</span><span class="time-divider">|</span><span id="duration">00:00</span>
      </div>
    </div>

    <div class="controls">
      <button id="prevBtn" class="icon-btn" aria-label="前の曲へ">
        <svg viewBox="0 0 24 24"><path d="M19 20V4L9 12l10 8zM5 20V4h2v16H5z"/></svg>
      </button>
      <button id="playBtn" class="icon-btn" aria-label="再生/一時停止">
        <svg id="playIcon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
      </button>
      <button id="nextBtn" class="icon-btn" aria-label="次の曲へ">
        <svg viewBox="0 0 24 24"><path d="M5 4v16l10-8L5 4zm12 0v16h2V4h-2z"/></svg>
      </button>
    </div>

    <div class="volume">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.06c1.48-.74 2.5-2.26 2.5-4.03z"/></svg>
      <input type="range" id="volume" class="vol-range" min="0" max="1" step="0.01" value="1" aria-label="音量">
    </div>

    <select id="track" style="display:none"></select>
  </main>

  <div class="foot">© 2025 KOBE TENKU RESORT</div>

  <audio id="audio" preload="auto" playsinline></audio>

<script>
  const bust=`?v=${Date.now()}`;

  /* ===== プレイリスト（ファイル名に合わせて反映） ===== */
  const playlist = [
    { title:"Track 2",  src:`/assets/audio/Track2_WAV.m4a${bust}`,           bg:`/assets/images/bg1.jpg${bust}` },
    { title:"Track 3",  src:`/assets/audio/Track3_2025102514WAV.m4a${bust}`,  bg:`/assets/images/bg2.jpg${bust}` },
    { title:"Track 4",  src:`/assets/audio/Track4_2025100419WAV.m4a${bust}`,  bg:`/assets/images/bg3.jpg${bust}` },
    { title:"Track 5",  src:`/assets/audio/Track5_2025101614WAV.m4a${bust}`,  bg:`/assets/images/bg4.JPG${bust}` },  // 大文字拡張子
    { title:"Track 7",  src:`/assets/audio/Track7_2025102514WAV.m4a${bust}`,  bg:`/assets/images/bg5.jpg${bust}` },
    { title:"Track 9",  src:`/assets/audio/Track9_1812102012WAV.m4a${bust}`,  bg:`/assets/images/bg6.jpg${bust}` },
    { title:"Track 10", src:`/assets/audio/Track10_2025102447WAV.m4a${bust}`, bg:`/assets/images/bg7.jpg${bust}` },
    { title:"Sound 3",  src:`/assets/audio/sound3.mp3${bust}`,                 bg:`/assets/images/bg9.JPG${bust}` }   // 大文字拡張子
  ];

  /* ===== 参照 ===== */
  const audio=document.getElementById('audio');
  const playBtn=document.getElementById('playBtn');
  const playIcon=document.getElementById('playIcon');
  const prevBtn=document.getElementById('prevBtn');
  const nextBtn=document.getElementById('nextBtn');
  const trackTitle=document.getElementById('trackTitle');
  const trackSub=document.getElementById('trackSub');
  const currentEl=document.getElementById('current');
  const durationEl=document.getElementById('duration');
  const ring=document.getElementById('ring');
  const knob=document.getElementById('knob');
  const cover=document.getElementById('cover');
  const dial=document.getElementById('dial');
  const volume=document.getElementById('volume');
  const bgA=document.getElementById('bgA');
  const bgB=document.getElementById('bgB');

  let activeIsA=true, dragging=false, idx=0;

  /* Web Audio（iOS音量） */
  let audioCtx=null,gainNode=null,mediaSrc=null;
  function ensureAudioGraph(){
    if(audioCtx) return;
    const Ctx=window.AudioContext||window.webkitAudioContext; if(!Ctx) return;
    audioCtx=new Ctx();
    try{ mediaSrc=audioCtx.createMediaElementSource(audio);}catch(e){}
    gainNode=audioCtx.createGain();
    mediaSrc&&mediaSrc.connect(gainNode); gainNode.connect(audioCtx.destination);
    gainNode.gain.value=Number(volume.value);
  }
  function resumeContextIfNeeded(){ if(audioCtx&&audioCtx.state==="suspended"){ audioCtx.resume().catch(()=>{});} }
  function setVolumeFromSlider(v){ const n=Number(v); if(gainNode){gainNode.gain.value=n;} else { audio.volume=n; } }

  const fmt=t=>`${String(Math.floor(t/60)).padStart(2,'0')}:${String(Math.floor(t%60)).padStart(2,'0')}`;

  function xfadeBackground(url){
    const front=activeIsA?bgB:bgA, back=activeIsA?bgA:bgB;
    const img=new Image();
    img.onload=()=>{ front.style.backgroundImage=`url("${url}")`; front.classList.add('is-active'); back.classList.remove('is-active'); activeIsA=!activeIsA; cover.style.backgroundImage=`url("${url}")`; };
    img.src=url;
  }

  function loadTrack(i, autoPlay=false){
    idx=(i+playlist.length)%playlist.length;
    const tr=playlist[idx];
    // m4a は audio/mp4, mp3 は audio/mpeg として両方差し込む（ブラウザ互換）
    audio.innerHTML = `
      <source src="${tr.src}" ${tr.src.endsWith('.mp3'+bust) ? 'type="audio/mpeg"' : 'type="audio/mp4"'} />
    `;
    audio.load();
    trackTitle.textContent = tr.title;
    trackSub.textContent = "Ambient · Loop";
    xfadeBackground(tr.bg);
    if(autoPlay){ ensureAudioGraph(); resumeContextIfNeeded(); audio.play().then(()=>updatePlayIcon(true)).catch(()=>{}); }
    else { updatePlayIcon(false); }
  }

  function updatePlayIcon(playing){
    playIcon.innerHTML = playing
      ? '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>'
      : '<path d="M8 5v14l11-7z"/>';
  }

  function setProgressUI(){
    const d=audio.duration||0, t=audio.currentTime||0;
    currentEl.textContent=fmt(t); durationEl.textContent=fmt(d);
    const p=d?(t/d):0;
    ring.style.setProperty('--progress', p);
    knob.style.transform=`translate(-50%,-6px) rotate(${p*360}deg)`;
  }

  function angleFromEvent(ev){
    const rect=dial.getBoundingClientRect();
    const cx=rect.left+rect.width/2, cy=rect.top+rect.height/2;
    const pt=('touches' in ev && ev.touches.length)? ev.touches[0] : ev;
    let theta=Math.atan2(pt.clientY-cy, pt.clientX-cx); // 右=0
    theta += Math.PI/2; if(theta<0) theta += Math.PI*2; // 真上=0
    return theta/(Math.PI*2);
  }
  function scrubTo(p){ const d=audio.duration||0; if(d){ audio.currentTime=p*d; setProgressUI(); } }
  function down(e){ dragging=true; scrubTo(angleFromEvent(e)); e.preventDefault(); }
  function move(e){ if(dragging) scrubTo(angleFromEvent(e)); }
  function up(){ dragging=false; }

  dial.addEventListener('pointerdown',down,{passive:false});
  window.addEventListener('pointermove',move,{passive:false});
  window.addEventListener('pointerup',up,{passive:false});
  dial.addEventListener('touchstart',down,{passive:false});
  window.addEventListener('touchmove',move,{passive:false});
  window.addEventListener('touchend',up,{passive:false});

  playBtn.addEventListener('click',async()=>{
    ensureAudioGraph(); resumeContextIfNeeded();
    if(audio.paused){ try{ await audio.play(); updatePlayIcon(true);}catch(e){} }
    else { audio.pause(); updatePlayIcon(false); }
  });
  prevBtn.addEventListener('click',()=> loadTrack(idx-1,true));
  nextBtn.addEventListener('click',()=> loadTrack(idx+1,true));

  volume.addEventListener('input',e=>{ ensureAudioGraph(); resumeContextIfNeeded(); setVolumeFromSlider(e.target.value); });

  audio.addEventListener('loadedmetadata',setProgressUI);
  audio.addEventListener('timeupdate',()=>{ if(!dragging) setProgressUI(); });
  audio.addEventListener('ended',()=> loadTrack(idx+1,true));

  (function init(){
    ensureAudioGraph(); setVolumeFromSlider(volume.value);
    loadTrack(0,false);
  })();
</script>
</body>
</html>
