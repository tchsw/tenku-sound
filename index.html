<script>
  const bust = `?v=${Date.now()}`;

  /* ===== プレイリスト ===== */
  const playlist = [
    { name:"Track 2",  src:`/assets/audio/Track2_WAV.m4a${bust}`,           bg:`/assets/images/bg1.jpg${bust}` },
    { name:"Track 3",  src:`/assets/audio/Track3_2025102514WAV.m4a${bust}`,  bg:`/assets/images/bg2.jpg${bust}` },
    { name:"Track 4",  src:`/assets/audio/Track4_2025100419WAV.m4a${bust}`,  bg:`/assets/images/bg3.jpg${bust}` },
    { name:"Track 5",  src:`/assets/audio/Track5_2025101614WAV.m4a${bust}`,  bg:`/assets/images/bg4.JPG${bust}` },
    { name:"Track 7",  src:`/assets/audio/Track7_2025102514WAV.m4a${bust}`,  bg:`/assets/images/bg5.jpg${bust}` },
    { name:"Track 9",  src:`/assets/audio/Track9_1812102012WAV.m4a${bust}`,  bg:`/assets/images/bg6.jpg${bust}` },
    { name:"Track10",  src:`/assets/audio/Track10_2025102447WAV.m4a${bust}`, bg:`/assets/images/bg7.jpg${bust}` },
    { name:"Sound 3",  src:`/assets/audio/sound3.mp3${bust}`,                 bg:`/assets/images/bg9.JPG${bust}` }
  ];

  /* ===== チューナークリック音 ===== */
  const tunerClick = new Audio(`/assets/audio/tuner.mp3${bust}`);
  tunerClick.preload = "auto";
  tunerClick.volume = 0.3; // 音量は控えめ（0〜1）

  function playTunerClick() {
    try {
      tunerClick.currentTime = 0;
      tunerClick.play();
    } catch (e) {
      // モバイルでの無視対策（初回タップ後は再生可）
    }
  }

  /* ===== FMレンジとステーション位置 ===== */
  const FM_MIN=88.0, FM_MAX=108.0;
  const stations = playlist.map((p,i,arr)=>{
    const t = (i+1)/(arr.length+1);
    const freq = +(FM_MIN + (FM_MAX-FM_MIN)*t).toFixed(1);
    return { freq, title:p.name };
  });

  /* ===== 要素 ===== */
  const audio = document.getElementById('audio');
  const playIcon = document.getElementById('playIcon');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const vol = document.getElementById('volume');
  const hms = document.getElementById('hms');
  const scale = document.getElementById('scale');
  const track = document.getElementById('track');
  const freqNum = document.getElementById('freqNum');
  const stationName = document.getElementById('stationName');
  const trackTitle = document.getElementById('trackTitle');
  const bgA = document.getElementById('bgA');
  const bgB = document.getElementById('bgB');

  /* ===== 背景クロスフェード ===== */
  let bgOnA = true;
  function swapBg(url){
    const front = bgOnA ? bgB : bgA;
    const back  = bgOnA ? bgA : bgB;
    const img = new Image();
    img.onload = ()=>{
      front.style.backgroundImage = `url("${url}")`;
      front.classList.add('is-active');
      back.classList.remove('is-active');
      bgOnA = !bgOnA;
    };
    img.src = url;
  }

  /* ===== Web Audio（アプリ内ボリューム） ===== */
  let ctx=null, gain=null, srcNode=null;
  const VOL_KEY='tenku_radio_volume';
  function ensureAudio(){
    if(ctx) return;
    const Ctx = window.AudioContext || window.webkitAudioContext;
    if(!Ctx) return;
    ctx = new Ctx();
    try{ srcNode = ctx.createMediaElementSource(audio); }catch(_){}
    gain = ctx.createGain();
    srcNode && srcNode.connect(gain);
    gain.connect(ctx.destination);
    const saved = localStorage.getItem(VOL_KEY);
    if(saved!=null) vol.value = saved;
    const v = +vol.value;
    gain.gain.value = v; audio.volume = v;
  }
  function setAppVolume(v){
    const n = Math.max(0, Math.min(1, +v));
    if(gain) gain.gain.value = n;
    audio.volume = n;
    localStorage.setItem(VOL_KEY, String(n));
  }
  vol.addEventListener('input', e => { ensureAudio(); setAppVolume(e.target.value); });

  /* ===== スケール幾何 ===== */
  let currentIndex=-1;
  let trackWidthPx=0, viewWidthPx=0;
  let minOffset=0, maxOffset=0;
  let offset=0;

  const posToFreq = p => +(FM_MIN + p*(FM_MAX-FM_MIN)).toFixed(1);
  const freqToPos = f => (f-FM_MIN)/(FM_MAX-FM_MIN);

  function layout(){
    viewWidthPx = scale.clientWidth;
    trackWidthPx = viewWidthPx * 2;
    track.style.width = trackWidthPx + 'px';
    minOffset = viewWidthPx - trackWidthPx;
    maxOffset = 0;
    track.querySelectorAll('.station').forEach(el=>el.remove());
    stations.forEach((s)=>{
      const t = freqToPos(s.freq);
      const x = t * trackWidthPx;
      const m = document.createElement('div');
      m.className='station';
      m.style.left = (x|0) + 'px';
      track.appendChild(m);
    });
    if(currentIndex>=0) alignToStation(currentIndex, false);
  }

  function setOffset(px){
    offset = Math.max(minOffset, Math.min(maxOffset, px));
    track.style.transform = `translateX(${offset}px)`;
    const centerX = viewWidthPx/2;
    const pos = (centerX - offset) / trackWidthPx;
    const f = posToFreq(pos);
    freqNum.textContent = f.toFixed(1);
    const near = nearestByPos(pos);
    highlightStation(near.i);
    stationName.textContent = `${stations[near.i].freq.toFixed(1)} MHz — ${playlist[near.i].name}`;
  }

  function nearestByPos(p){
    let best={i:0,d:Infinity,t:0};
    stations.forEach((s,i)=>{
      const t=freqToPos(s.freq);
      const d=Math.abs(t-p);
      if(d<best.d) best={i,d,t};
    });
    return best;
  }
  function highlightStation(i){
    const nodes = track.querySelectorAll('.station');
    nodes.forEach((n,idx)=>n.classList.toggle('is-hot', idx===i));
  }

  function alignToStation(i, play=true){
    i=(i+playlist.length)%playlist.length;
    const t = freqToPos(stations[i].freq);
    const stationX = t * trackWidthPx;
    const centerX  = viewWidthPx/2;
    const targetOffset = centerX - stationX;
    setOffset(targetOffset);
    playTunerClick(); // スナップ時にカチッ音
    if(play) loadByIndex(i,true);
  }

  /* ===== 再生制御 ===== */
  function loadByIndex(i,auto=true){
    i=(i+playlist.length)%playlist.length;
    currentIndex=i;
    const tr=playlist[i];
    const isMp3=/\.mp3\?v=/.test(tr.src);
    audio.innerHTML=`<source src="${tr.src}" type="${isMp3?'audio/mpeg':'audio/mp4'}">`;
    audio.load();
    trackTitle.textContent=tr.name;
    swapBg(tr.bg);
    if(auto){ ensureAudio(); ctx && ctx.resume(); audio.play().then(()=>updatePlayIcon(true)).catch(()=>{}); }
    highlightStation(i);
  }
  function updatePlayIcon(playing){
    playIcon.innerHTML = playing
      ? '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>'
      : '<path d="M8 5v14l11-7z"/>';
  }

  /* ===== ドラッグ操作 ===== */
  let dragging=false, lastX=0, lastClickTime=0;
  function clientX(e){ return (e.touches? e.touches[0].clientX : e.clientX); }
  function begin(e){ dragging=true; lastX=clientX(e); e.preventDefault(); playTunerClick(); }
  function move(e){
    if(!dragging) return;
    const x = clientX(e);
    const dx = x - lastX;
    lastX = x;
    setOffset(offset + dx);
    // 間隔をあけてクリック音
    const now = performance.now();
    if(now - lastClickTime > 300){ playTunerClick(); lastClickTime = now; }
  }
  function end(){
    if(!dragging) return; dragging=false;
    const centerPos = (viewWidthPx/2 - offset) / trackWidthPx;
    const near = nearestByPos(centerPos);
    alignToStation(near.i, true);
  }
  scale.addEventListener('pointerdown',begin,{passive:false});
  window.addEventListener('pointermove',move,{passive:false});
  window.addEventListener('pointerup',end,{passive:false});
  scale.addEventListener('touchstart',begin,{passive:false});
  window.addEventListener('touchmove',move,{passive:false});
  window.addEventListener('touchend',end,{passive:false});

  /* ===== キー & ボタン ===== */
  window.addEventListener('keydown',e=>{
    if(e.key==='ArrowRight') alignToStation((currentIndex<0?0:currentIndex)+1, true);
    if(e.key==='ArrowLeft')  alignToStation((currentIndex<0?0:currentIndex)-1, true);
  });
  document.getElementById('playBtn').addEventListener('click',async()=>{
    ensureAudio();
    if(audio.paused){ await audio.play().catch(()=>{}); updatePlayIcon(true); }
    else{ audio.pause(); updatePlayIcon(false); }
  });
  document.getElementById('prevBtn').addEventListener('click',()=>alignToStation(currentIndex-1,true));
  document.getElementById('nextBtn').addEventListener('click',()=>alignToStation(currentIndex+1,true));

  /* ===== 時間表示 & 連続再生 ===== */
  const pad=n=>String(n).padStart(2,'0');
  audio.addEventListener('timeupdate',()=>{
    const t=Math.floor(audio.currentTime);
    hms.textContent=`${pad((t/60)|0)}:${pad(t%60)}`;
  });
  audio.addEventListener('ended',()=>alignToStation(currentIndex+1,true));

  /* ===== 初期化 ===== */
  window.addEventListener('resize', ()=>layout());
  (function init(){
    layout();
    const centerPos = 0.5;
    const near = nearestByPos(centerPos);
    const t = freqToPos(stations[near.i].freq);
    const stationX = t * trackWidthPx;
    const centerX = viewWidthPx/2;
    offset = centerX - stationX;
    track.style.transform = `translateX(${offset}px)`;
    ensureAudio();
    const saved = localStorage.getItem(VOL_KEY);
    if(saved!=null) setAppVolume(saved);
    loadByIndex(near.i,false);
  })();
</script>
